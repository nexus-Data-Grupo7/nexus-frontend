<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin</title>
    <link rel="stylesheet" href="./css/dash_adm.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
        integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

</head>

<body>

    <button class="menu-toggle" onclick="toggleMenu()" aria-label="Abrir menu">
        <i class="fa-solid fa-bars"></i>
    </button>

    <div class="overlay" onclick="toggleMenu()"></div>

    <nav id="nav">
        <div class="navHora">
            22:10
            <div class="navData">
                Segunda-feira, 23 de nov 2020
            </div>
        </div>

        <div class="navLinks" id="divNavLinks">
            <a href="dashboard.html" class="navLinksLogo">
                <img src="images/icon_link_home.svg" alt="">
                Home
            </a>
            <a href="ranking.html" class="navLinksLogo">
                <img src="images/icon_link_ranking.svg" alt="">
                Ranking
            </a>
            <a href="perfil.html" class="navLinksLogo">
                <img src="images/icon_link_usuarios.svg" alt="">
                Perfil
            </a>
            <a href="administracao.html" class="navLinksLogo">
                <img src="images/icon_link_usuarios.svg" alt="">
                Administrador
            </a>
        </div>
        
        <div class="navUserInfo" id="divNavUserInfo">
            <div>
                <img src="images/icon_camera.svg" alt="">
            </div>
            <div>
                <div>nomesobrenome</div>
                <div>email@gmail.com</div>
            </div>
        </div>

        <button class="navExit" onclick="redirectLogin()">
            Sair
            <div>
                <img src="images/icon_sair.svg" alt="">
            </div>
        </button>
    </nav>

    <div class="container">
        <!-- Botões de Seleção -->
        <div class="botoes-selecao">
            <button class="btn-selecao active" onclick="selecionarTipo('administrador')">
                <i class="fa-solid fa-user-shield"></i> Administradores
            </button>
            <button class="btn-selecao" onclick="selecionarTipo('jogador')">
                <i class="fa-solid fa-gamepad"></i> Jogadores
            </button>
            <button class="btn-selecao" onclick="selecionarTipo('organizacao')">
                <i class="fa-solid fa-building"></i> Organizações
            </button>
        </div>

        <div class="sindico-criar">
            <span id="title-sindico">Administradores</span>
            <button id="button-criar"><img src="./images/plus.png" alt="">CRIAR</button>
        </div>

        <!-- Modal Criar Admin -->
        <div class="fundo-modal" id="fundoModal">
            <div class="modal">
                <div class="cabecalho-modal">
                    <h2 class="titulo-modal">Cadastro de Administrador</h2>
                    <button class="botao-fechar" id="botaoFechar">&times;</button>
                </div>

                <form id="formularioAdministrador">
                    <div class="grupo-form">
                        <label for="nomeAdmin">Nome Completo:</label>
                        <input type="text" id="nomeAdmin" name="nomeAdmin" placeholder="Digite o nome completo" required>
                    </div>

                    <div class="grupo-form">
                        <label for="emailAdmin">Email:</label>
                        <input type="email" id="emailAdmin" name="emailAdmin" placeholder="email@exemplo.com" required>
                    </div>

                    <div class="grupo-form">
                        <label for="senhaAdmin">Senha:</label>
                        <input type="password" id="senhaAdmin" name="senhaAdmin" placeholder="Digite a senha" required>
                    </div>

                    <div class="grupo-form">
                        <label for="confirmarSenhaAdmin">Confirmar Senha:</label>
                        <input type="password" id="confirmarSenhaAdmin" name="confirmarSenhaAdmin" placeholder="Confirme a senha" required>
                    </div>

                    <div class="botoes">
                        <button type="button" class="botao-cancelar" id="botaoCancelar">Cancelar</button>
                        <button type="button" class="botao-salvar" onclick="cadastrar()">Salvar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal Editar Admin -->
        <div class="fundo-modal" id="fundoModalEditar">
            <div class="modal">
                <div class="cabecalho-modalEditar">
                    <h2 class="titulo-modalEditar">Editar Administrador</h2>
                    <button class="botao-fechar" onclick="fecharModalEditar()">&times;</button>
                </div>

                <form id="formularioEditarAdministrador">
                    <div class="grupo-form">
                        <label for="editarNome">Nome Completo:</label>
                        <input type="text" id="editarNome" name="editarNome" required>
                    </div>

                    <div class="grupo-form">
                        <label for="editarEmail">Email:</label>
                        <input type="email" id="editarEmail" name="editarEmail" required>
                    </div>

                    <div class="grupo-form">
                        <label for="editarSenha">Nova Senha (opcional):</label>
                        <input type="password" id="editarSenha" name="editarSenha" placeholder="Deixe em branco para manter a atual">
                    </div>

                    <div class="botoes">
                        <button type="button" class="botao-cancelar" onclick="fecharModalEditar()">Cancelar</button>
                        <button type="button" class="botao-salvar" onclick="salvarEdicao()">Salvar</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="fundo-modal" id="fundoModalExcluir">
            <div class="modal">
                <h2>Confirmar exclusão</h2>
                <p id="mensagemExclusao">Tem certeza que deseja excluir este registro?</p>
                <div class="botoes">
                    <button class="botaoExcluir" type="button" onclick="cancelarExclusao()">Cancelar</button>
                    <button class="botaoExcluir" type="button" onclick="confirmarExclusao()">Excluir</button>
                </div>
            </div>
        </div>

        <div class="tabela">
            <table border="1" class="tabela-fisica">
                <thead id="tabela-head">
                    <tr>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Data de Cadastro</th>
                        <th>Editar</th>
                        <th>Excluir</th>
                    </tr>
                </thead>
                <tbody id="tabela-administradores">

                </tbody>
            </table>
        </div>
    </div>

</body>

</html>

<script>
    let tipoAtual = 'administrador';
    let idAtual = null;

    function redirectLogin(){
        window.location = "login.html";
    }

    document.addEventListener('DOMContentLoaded', function () {
        const tipoConta = sessionStorage.getItem("TIPO_CONTA");

        if (tipoConta !== "ADMINISTRADOR") {
            alert("Acesso negado! Apenas administradores podem acessar esta página.");
            window.location.href = "login.html";
            return;
        }

        carregarDados();
    });

    function selecionarTipo(tipo) {
        tipoAtual = tipo;
        
        document.querySelectorAll('.btn-selecao').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.closest('.btn-selecao').classList.add('active');

        const titulos = {
            'administrador': 'Administradores',
            'jogador': 'Jogadores',
            'organizacao': 'Organizações'
        };
        document.getElementById('title-sindico').textContent = titulos[tipo];

        document.getElementById('button-criar').style.display = tipo === 'administrador' ? 'flex' : 'none';

        carregarDados();
    }

    async function carregarDados() {
        if (tipoAtual === 'administrador') {
            carregarAdministradores();
        } else if (tipoAtual === 'jogador') {
            carregarJogadores();
        } else if (tipoAtual === 'organizacao') {
            carregarOrganizacoes();
        }
    }

    async function carregarAdministradores() {
        try {
            const resposta = await fetch("/usuarios/administradores/listar");
            const administradores = await resposta.json();

            const thead = document.getElementById("tabela-head");
            const tbody = document.getElementById("tabela-administradores");
            
            thead.innerHTML = `
                <tr>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Data de Cadastro</th>
                    <th>Editar</th>
                    <th>Excluir</th>
                </tr>
            `;
            
            tbody.innerHTML = "";

            if (administradores.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px;">
                            Nenhum administrador cadastrado
                        </td>
                    </tr>
                `;
                return;
            }

            administradores.forEach(admin => {
                const tr = document.createElement("tr");
                const isNexus = admin.email === 'nexus@gmail.com';

                tr.innerHTML = `
                    <td>${admin.nome}</td>
                    <td>${admin.email}</td>
                    <td>${admin.data_cadastro || 'N/A'}</td>
                    <td>
                        <button onclick="abrirModalEditar(${admin.id_admin}, '${admin.nome}', '${admin.email}')">
                            <img src="../assets/icons_cadastro/edit.png" alt="Editar">
                        </button>
                    </td>
                    <td>
                        ${isNexus ?
                            '<span style="color: #999; font-size: 0.85rem;">Protegido</span>' :
                            `<button onclick="abrirModalExcluir(${admin.id_admin})">
                                <img src="../assets/icons_cadastro/delete.png" alt="Excluir">
                            </button>`
                        }
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (erro) {
            console.error("Erro ao carregar administradores:", erro);
            alert("Erro ao carregar a lista de administradores.");
        }
    }

    async function carregarJogadores() {
        try {
            const resposta = await fetch("/jogadores/listar");
            const jogadores = await resposta.json();

            const thead = document.getElementById("tabela-head");
            const tbody = document.getElementById("tabela-administradores");
            
            thead.innerHTML = `
                <tr>
                    <th>Game Name</th>
                    <th>Tag</th>
                    <th>Nome</th>
                    <th>Região</th>
                    <th>Elo</th>
                    <th>Organização</th>
                    <th>Excluir</th>
                </tr>
            `;
            
            tbody.innerHTML = "";

            if (jogadores.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px;">
                            Nenhum jogador cadastrado
                        </td>
                    </tr>
                `;
                return;
            }

            jogadores.forEach(jogador => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${jogador.game_name}</td>
                    <td>${jogador.tagline || '-'}</td>
                    <td>${jogador.nome}</td>
                    <td>${jogador.nome_regiao || 'N/A'}</td>
                    <td>${jogador.nome_elo || 'N/A'}</td>
                    <td>${jogador.nome_org || 'Sem Org'}</td>
                    <td>
                        <button onclick="abrirModalExcluirJogador(${jogador.id_jogador})">
                            <img src="../assets/icons_cadastro/delete.png" alt="Excluir">
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (erro) {
            console.error("Erro ao carregar jogadores:", erro);
            alert("Erro ao carregar a lista de jogadores.");
        }
    }

    async function carregarOrganizacoes() {
        try {
            const resposta = await fetch("/organizacoes/listar");
            const organizacoes = await resposta.json();

            const thead = document.getElementById("tabela-head");
            const tbody = document.getElementById("tabela-administradores");
            
            thead.innerHTML = `
                <tr>
                    <th>Nome</th>
                    <th>Sigla</th>
                    <th>CNPJ</th>
                    <th>Email</th>
                    <th>Data Cadastro</th>
                    <th>Excluir</th>
                </tr>
            `;
            
            tbody.innerHTML = "";

            if (organizacoes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px;">
                            Nenhuma organização cadastrada
                        </td>
                    </tr>
                `;
                return;
            }

            organizacoes.forEach(org => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${org.nome_org}</td>
                    <td>${org.sigla || '-'}</td>
                    <td>${org.cnpj}</td>
                    <td>${org.email}</td>
                    <td>${org.data_cadastro || 'N/A'}</td>
                    <td>
                        <button onclick="abrirModalExcluirOrganizacao(${org.id_organizacao})">
                            <img src="../assets/icons_cadastro/delete.png" alt="Excluir">
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (erro) {
            console.error("Erro ao carregar organizações:", erro);
            alert("Erro ao carregar a lista de organizações.");
        }
    }

    function abrirModalExcluirJogador(idJogador) {
        idAtual = idJogador;
        document.getElementById('mensagemExclusao').textContent = 'Tem certeza que deseja excluir este jogador?';
        document.getElementById('fundoModalExcluir').classList.add('ativo');
    }

    function abrirModalExcluirOrganizacao(idOrganizacao) {
        idAtual = idOrganizacao;
        document.getElementById('mensagemExclusao').textContent = 'Tem certeza que deseja excluir esta organização?';
        document.getElementById('fundoModalExcluir').classList.add('ativo');
    }

    async function confirmarExclusao() {
        try {
            let endpoint = '';
            let body = {};

            if (tipoAtual === 'administrador') {
                endpoint = '/usuarios/administradores/excluir';
                body = { idAdmin: idAtual };
            } else if (tipoAtual === 'jogador') {
                endpoint = '/jogadores/excluir';
                body = { idJogador: idAtual };
            } else if (tipoAtual === 'organizacao') {
                endpoint = '/organizacoes/excluir';
                body = { idOrganizacao: idAtual };
            }

            const resposta = await fetch(endpoint, {
                method: "DELETE",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });

            const json = await resposta.json();

            if (resposta.ok) {
                alert(`${tipoAtual.charAt(0).toUpperCase() + tipoAtual.slice(1)} excluído(a) com sucesso!`);
                cancelarExclusao();
                carregarDados();
            } else {
                alert(json.erro || `Erro ao excluir ${tipoAtual}`);
            }
        } catch (erro) {
            console.error("Erro ao excluir:", erro);
            alert("Erro de conexão com o servidor.");
        }
    }

    async function cadastrar() {
        const nome = document.getElementById('nomeAdmin').value.trim();
        const email = document.getElementById('emailAdmin').value.trim();
        const senha = document.getElementById('senhaAdmin').value.trim();
        const confirmarSenha = document.getElementById('confirmarSenhaAdmin').value.trim();

        if (!nome || !email || !senha || !confirmarSenha) {
            alert('Preencha todos os campos!');
            return;
        }

        if (!validarEmail(email)) {
            alert('Digite um e-mail válido!');
            return;
        }

        if (senha.length < 6) {
            alert('A senha deve ter no mínimo 6 caracteres!');
            return;
        }

        if (senha !== confirmarSenha) {
            alert('As senhas não coincidem!');
            return;
        }

        const senhaHash = CryptoJS.SHA256(senha).toString();

        try {
            const resposta = await fetch("/usuarios/administradores/cadastrar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    nomeServer: nome,
                    emailServer: email,
                    senhaServer: senhaHash
                })
            });

            const json = await resposta.json();

            if (resposta.ok) {
                alert("Administrador cadastrado com sucesso!");
                document.getElementById('fundoModal').classList.remove('ativo');
                document.getElementById('formularioAdministrador').reset();
                carregarAdministradores();
            } else {
                alert(json.erro || "Erro ao cadastrar administrador");
            }
        } catch (erro) {
            console.error("Erro ao cadastrar:", erro);
            alert("Erro de conexão com o servidor.");
        }
    }

    function abrirModalEditar(idAdmin, nome, email) {
        idAtual = idAdmin;
        document.getElementById('editarNome').value = nome;
        document.getElementById('editarEmail').value = email;
        document.getElementById('editarSenha').value = '';
        document.getElementById('fundoModalEditar').classList.add('ativo');
    }

    async function salvarEdicao() {
        const nome = document.getElementById('editarNome').value.trim();
        const email = document.getElementById('editarEmail').value.trim();
        const senha = document.getElementById('editarSenha').value.trim();

        if (!nome || !email) {
            alert('Nome e e-mail são obrigatórios!');
            return;
        }

        if (!validarEmail(email)) {
            alert('Digite um e-mail válido!');
            return;
        }

        let senhaHash = null;
        if (senha && senha.trim() !== '') {
            if (senha.length < 6) {
                alert('A nova senha deve ter no mínimo 6 caracteres!');
                return;
            }
            senhaHash = CryptoJS.SHA256(senha).toString();
        }

        try {
            const resposta = await fetch("/usuarios/administradores/editar", {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    idAdmin: idAtual,
                    nomeServer: nome,
                    emailServer: email,
                    senhaServer: senhaHash
                })
            });

            const json = await resposta.json();

            if (resposta.ok) {
                alert("Administrador atualizado com sucesso!");
                fecharModalEditar();
                carregarAdministradores();
            } else {
                alert(json.erro || "Erro ao editar administrador");
            }
        } catch (erro) {
            console.error("Erro ao editar:", erro);
            alert("Erro de conexão com o servidor.");
        }
    }

    function abrirModalExcluir(idAdmin) {
        idAtual = idAdmin;
        document.getElementById('mensagemExclusao').textContent = 'Tem certeza que deseja excluir este administrador?';
        document.getElementById('fundoModalExcluir').classList.add('ativo');
    }

    function fecharModalEditar() {
        document.getElementById('fundoModalEditar').classList.remove('ativo');
        idAtual = null;
    }

    function cancelarExclusao() {
        document.getElementById('fundoModalExcluir').classList.remove('ativo');
        idAtual = null;
    }

    function validarEmail(email) {
        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return regex.test(email);
    }

    document.getElementById('button-criar')?.addEventListener('click', () => {
        document.getElementById('fundoModal').classList.add('ativo');
    });

    document.getElementById('botaoFechar')?.addEventListener('click', () => {
        document.getElementById('fundoModal').classList.remove('ativo');
    });

    document.getElementById('botaoCancelar')?.addEventListener('click', () => {
        document.getElementById('fundoModal').classList.remove('ativo');
    });

    function toggleMenu() {
        const nav = document.getElementById('nav');
        const overlay = document.querySelector('.overlay');
        const menuToggle = document.querySelector('.menu-toggle');

        nav.classList.toggle('active');
        overlay.classList.toggle('active');

        const icon = menuToggle.querySelector('i');
        if (nav.classList.contains('active')) {
            icon.classList.replace('fa-bars', 'fa-times');
            menuToggle.setAttribute('aria-label', 'Fechar menu');
            document.body.style.overflow = 'hidden';
        } else {
            icon.classList.replace('fa-times', 'fa-bars');
            menuToggle.setAttribute('aria-label', 'Abrir menu');
            document.body.style.overflow = '';
        }
    }

    document.querySelectorAll('.navLinksLogo').forEach(link => {
        link.addEventListener('click', () => {
            if (window.innerWidth <= 768) {
                toggleMenu();
            }
        });
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const nav = document.getElementById('nav');
            if (nav.classList.contains('active')) {
                toggleMenu();
            }
        }
    });

</script>