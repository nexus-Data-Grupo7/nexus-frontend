<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Cadastro</title>
    <link rel="stylesheet" href="./css/cadastro.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
        integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>

    <div class="container">

        <button class="menu-toggle" onclick="toggleMenu()" aria-label="Abrir menu">
            <i class="fa-solid fa-bars"></i>
        </button>

        <div class="overlay" onclick="toggleMenu()"></div>

        <nav id="nav">
            <div class="navLinks">
                <a href="index.html" class="navLinksLogo">
                    <img src="images/icon_link_home.svg" alt="">
                    Site
                </a>
            </div>
        </nav>

        <div class="left-area">
            <div class="phone-box">
                <img src="./images/celularNexus.png" class="phone-img">
            </div>
            <div class="grupo-linhas">
                <img src="images/linhas_grupo.svg" alt="">
            </div>

            <div class="description">
                Nosso propósito é <strong>fortalecer a comunidade gamer</strong>, dar visibilidade a novos talentos
                e apoiar organizações e <strong>patrocinadores</strong> com <strong>dados confiáveis</strong>.
            </div>
        </div>

        <div class="form-area">
            <h1>Cadastro</h1>

            <div class="tipo-usuario">
                <label><input type="radio" name="tipoUsuario" value="jogador" checked onchange="alterarTipoLogin()">
                    Jogador</label>
                <label><input type="radio" name="tipoUsuario" value="organizacao" onchange="alterarTipoLogin()">
                    Organização</label>
            </div>

            <div class="form-container">

                <!-- ===================== COLUNA ESQUERDA ===================== -->
                <div class="form-area parte-1">

                    <span>E-mail</span>
                    <div class="input">
                        <input type="email" id="input_email" placeholder="xpto@gmail.com">
                    </div>

                    <span>Senha</span>
                    <div class="input">
                        <input type="password" id="input_senha" placeholder="*******">
                    </div>

                    <span>Confirmar senha</span>
                    <div class="input">
                        <input type="password" id="input_confirmaSenha" placeholder="*******">
                    </div>

                    <!-- CAMPOS DO JOGADOR -->
                    <div id="campos_jogador_parte1">
                        <span>Nome</span>
                        <div class="input">
                            <input type="text" id="input_nome" placeholder="Seu nome">
                        </div>
                    </div>

                </div>

                <!-- ===================== COLUNA DIREITA ===================== -->
                <div class="form-area parte-2">

                    <!-- CAMPOS DO JOGADOR -->
                    <div id="campos_jogador_parte2">
                        <span>Data de nascimento</span>
                        <div class="input">
                            <input type="date" id="input_dataNascimento">
                        </div>

                        <span>Game Name</span>
                        <div class="input">
                            <input type="text" id="input_gameName" placeholder="Ex: Faker">
                        </div>

                        <span>Tagline</span>
                        <div class="input">
                            <input type="text" id="input_tagline" placeholder="Ex: #1234">
                        </div>

                        <span>Região</span>
                        <select id="select_regiao">
                            <option value="1">BR1 - Brasil</option>
                            <option value="2">NA1 - América do Norte</option>
                            <option value="3">LA1 - América Latina Norte</option>
                            <option value="4">LA2 - América Latina Sul</option>
                            <option value="5">KR - Coreia</option>
                        </select>
                    </div>

                    <!-- CAMPOS DA ORGANIZAÇÃO -->
                    <div id="campos_org_parte2" style="display: none;">

                        <span>Nome da Organização</span>
                        <div class="input">
                            <input type="text" id="input_nomeOrg" placeholder="Nome completo da organização">
                        </div>

                        <span>Sigla</span>
                        <div class="input">
                            <input type="text" id="input_sigla" placeholder="Ex: T1, FNC">
                        </div>

                        <span>CNPJ</span>
                        <div class="input">
                            <input type="text" id="input_cnpj" placeholder="Somente números" maxlength="14">
                        </div>

                    </div>

                </div>
            </div>

            <button class="btn" onclick="cadastrar()">Cadastrar</button>

            <div class="login-text">Já possui uma conta? <a href="login.html">clique aqui</a></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/build/sha256.min.js"></script>

</body>

</html>


<script>

    function toggleMenu() {
        const nav = document.getElementById('nav');
        const overlay = document.querySelector('.overlay');
        const menuToggle = document.querySelector('.menu-toggle');

        nav.classList.toggle('active');
        overlay.classList.toggle('active');

        const icon = menuToggle.querySelector('i');
        if (nav.classList.contains('active')) {
            icon.classList.replace('fa-bars', 'fa-times');
            menuToggle.setAttribute('aria-label', 'Fechar menu');
            document.body.style.overflow = 'hidden';
        } else {
            icon.classList.replace('fa-times', 'fa-bars');
            menuToggle.setAttribute('aria-label', 'Abrir menu');
            document.body.style.overflow = '';
        }
    }

    document.querySelectorAll('.navLinksLogo').forEach(link => {
        link.addEventListener('click', () => {
            if (window.innerWidth <= 768) {
                toggleMenu();
            }
        });
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const nav = document.getElementById('nav');
            if (nav.classList.contains('active')) {
                toggleMenu();
            }
        }
    });

    function alterarTipoLogin() {
        const tipo = document.querySelector('input[name="tipoUsuario"]:checked').value;

        const jog1 = document.getElementById("campos_jogador_parte1");
        const jog2 = document.getElementById("campos_jogador_parte2");
        const org2 = document.getElementById("campos_org_parte2");

        if (tipo === "jogador") {
            jog1.style.display = "block";
            jog2.style.display = "block";
            org2.style.display = "none";
        } else {
            jog1.style.display = "none";
            jog2.style.display = "none";
            org2.style.display = "block";
        }
    }

    function calcularIdade(dataNascimento) {
        const hoje = new Date();
        const nascimento = new Date(dataNascimento);
        let idade = hoje.getFullYear() - nascimento.getFullYear();
        const mesAtual = hoje.getMonth();
        const mesNascimento = nascimento.getMonth();

        if (mesAtual < mesNascimento || (mesAtual === mesNascimento && hoje.getDate() < nascimento.getDate())) {
            idade--;
        }

        return idade;
    }

    function validarEmail(email) {
        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return regex.test(email);
    }

    function validarCNPJ(cnpj) {
        return cnpj.length === 14 && /^\d+$/.test(cnpj);
    }

    async function cadastrar() {
        const email = document.getElementById("input_email").value.trim();
        const senha = document.getElementById("input_senha").value.trim();
        const confirma = document.getElementById("input_confirmaSenha").value.trim();
        const tipoConta = document.querySelector('input[name="tipoUsuario"]:checked').value.toUpperCase();

        if (!email || !senha || !confirma) {
            alert("Preencha todos os campos obrigatórios!");
            return;
        }

        if (!validarEmail(email)) {
            alert("Digite um e-mail válido!");
            return;
        }

        if (senha.length < 6) {
            alert("A senha deve ter no mínimo 6 caracteres!");
            return;
        }

        if (senha !== confirma) {
            alert("As senhas não coincidem!");
            return;
        }

        const senhaHash = sha256(senha);

        let body = {
            emailServer: email,
            senhaServer: senhaHash,
            tipoContaServer: tipoConta
        };

        if (tipoConta === "JOGADOR") {
            const nome = document.getElementById("input_nome").value.trim();
            const gameName = document.getElementById("input_gameName").value.trim();
            const tagline = document.getElementById("input_tagline").value.trim();
            const dataNascimento = document.getElementById("input_dataNascimento").value;
            const idRegiao = document.getElementById("select_regiao").value;

            if (!nome || !gameName || !tagline || !dataNascimento) {
                alert("Preencha todos os campos do jogador!");
                return;
            }

            const idade = calcularIdade(dataNascimento);

            if (idade < 13) {
                alert("Você deve ter pelo menos 13 anos para se cadastrar!");
                return;
            }

            body.nome = nome;
            body.gameName = gameName;
            body.tagline = tagline;
            body.idade = parseInt(idade);
            body.idRegiao = parseInt(idRegiao);

        } else {
            const nomeOrg = document.getElementById("input_nomeOrg").value.trim();
            const sigla = document.getElementById("input_sigla").value.trim();
            const cnpj = document.getElementById("input_cnpj").value.trim();

            if (!nomeOrg || !sigla || !cnpj) {
                alert("Preencha todos os campos da organização!");
                return;
            }

            if (!validarCNPJ(cnpj)) {
                alert("CNPJ inválido! Deve conter 14 dígitos numéricos.");
                return;
            }

            body.nomeOrg = nomeOrg;
            body.sigla = sigla;
            body.cnpj = cnpj;
        }

        try {
            const response = await fetch("/usuarios/cadastrar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });

            const data = await response.json();

            if (response.ok) {
                alert("Cadastro realizado com sucesso!");
                window.location.href = "login.html";
            } else {
                alert(data.erro || "Erro ao cadastrar!");
            }
        } catch (err) {
            console.error(err);
            alert("Erro de conexão com o servidor!");
        }
    }

</script>